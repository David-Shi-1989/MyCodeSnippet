<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Vue - 源码分析 - 02数据双向绑定</title>
  <style>
    * {margin: 0;padding: 0;}
    body {
      padding: 10px 5px;
    }
    #logger {
      width: 100%;
      height: 150px;
      background-color: #eee;
      box-sizing: border-box;
      margin: 20px auto;
      padding: 10px;
      overflow: auto;
    }
    #logger p {
      font-size: 12px;
      color:#888;
    }
  </style>
</head>
<body>
  <div style="padding: 10px;border:2px solid #777;display:inline-block;">
    <img src="../../../../assets/image/iphone.jpg" style="width:200px;display: block;margin-bottom: 5px;box-sizing: border-box;">
    <input type="number" id="input_price" value="5499" style="padding: 2px;width:105px;margin-right:5px;"/>
    <button onclick="setPrice()" style="width:80px;">确认价格</button>
  </div>
  <div id="logger">
  </div>
  <script type="text/javascript">
    Date.prototype.format = function (formatStr) {
      var o = {
        'M+': this.getMonth() + 1,
        'd+': this.getDate(),
        'h+': this.getHours(),
        'H+': this.getHours(),
        'm+': this.getMinutes(),
        's+': this.getSeconds(),
        'q+': Math.floor((this.getMonth() + 3) / 3),
        'S': this.getMilliseconds()
      }
      if (/(y+)/.test(formatStr)) {
        formatStr = formatStr.replace(RegExp.$1, (String(this.getFullYear()).substr(4 - RegExp.$1.length)))
      }
      for (var k in o) {
        if (new RegExp(`(${k})`).test(formatStr)) {
          formatStr = formatStr.replace(RegExp.$1, RegExp.$1.length == 1 ? o[k] : ('00' + o[k]).substr(String(o[k]).length))
        }
      }
      return formatStr
    }

    function Observer (obj, key, value) {
      var dep = new Dep()
      if (Object.prototype.toString.call(value) == '[object object]') {
        Object.keys(value).forEach(function (key) {
          new Observer(value, key, value[key])
        })
      }
      Object.defineProperty(obj, key, {
        enumerable: true,
        configurable: true,
        get: function () {
          if (Dep.target) {
            dep.depend()
          }
          return value
        },
        set: function (newVal) {
          value = newVal
          dep.notify()
        }
      })
      this.obj = obj
      this.key = key
    }
    function Watcher (observer, fn) {
      this.lastValue = null
      this.update = function () {
        const curValue = observer.obj[observer.key]
        if (curValue !== this.lastValue) {
          Dep.target = this
          fn()
          Dep.target = null
          this.lastValue = curValue
        }
      }
      this.addDep = function (dep) {
        dep.addSub(this)
      }
      this.update()
    }
    function Dep () {
      this.subs = []
      this.addSub = function (watcher) {
        this.subs.push(watcher)
      }
      this.notify = function () {
        this.subs.forEach(function (watcher) {
          watcher.update()
        })
      }
      this.depend = function () {
        if (Dep.target) {
          Dep.target.addDep(this)
        }
      }
    }

    var iphone = {
      price: 5499
    }
    var iphonePriceObserver = new Observer(iphone, 'price', iphone.price)
    function User (name) {
      this.name = name
      var me = this
      this.watchPrice = function (observer, userCb) {
        me.watcher = new Watcher(observer, userCb)
      }
    }

    var david = new User('David')
    david.watchPrice(iphonePriceObserver, function () {
      log(`David get notify: ${iphone.price}`)
    })
    var peter = new User('Peter')
    peter.watchPrice(iphonePriceObserver, function () {
      log(`Peter get notify: ${iphone.price}`)
    })

    function setPrice () {
      iphone.price = parseInt(document.getElementById('input_price').value)
    }
    function log (text) {
      var newItem = document.createElement('p')
      newItem.innerText = `[${(new Date()).format('yyyy/MM/dd hh:mm:ss')}] ${text}`
      document.getElementById('logger').appendChild(newItem)
      logger.scrollTop=1000000
    }
  </script>
</body>
</html>